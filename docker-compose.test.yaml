services:
  processor-test:
    build:
      context: .
      dockerfile: processor/Dockerfile
      # Only include essential files for build (excludes assets via .dockerignore)
    # healthcheck:
    #   test: curl --fail http://127.0.0.1:5678/ || exit 1
    #   interval: 15s
    #   timeout: 1s
    #   retries: 5
    #   start_period: 2s
    ports:
      - '5678:5678'
    volumes:
      # - ./data:/data # need it for testing (pulling and pushing files to storage server)
      - ./processor:/app/processor
      - ./shared:/app/shared
      - ./assets:/app/assets
      # Mount your Ed25519 key directly
      - ~/.ssh/processing-to-storage:/tmp/ssh-keys/processing-to-storage:ro
      - ~/.ssh/processing-to-storage.pub:/tmp/ssh-keys/processing-to-storage.pub:ro
      # Docker socket for ODM container execution
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - PYTHONPATH=/app
      - PYTEST_ADDOPTS=--color=yes
      - STORAGE_SERVER_IP=nginx
      - STORAGE_SERVER_USERNAME=root
      - STORAGE_SERVER_DATA_PATH=/data
      - PROCESSOR_USERNAME=processor@deadtrees.earth
      - SUPABASE_URL=http://host.docker.internal:54321
      - SUPABASE_KEY=${SUPABASE_KEY}
      - BASE_DIR=/data
      - PROCESSOR_PASSWORD=${PROCESSOR_PASSWORD}
      # Update the path to use your Ed25519 key
      - SSH_PRIVATE_KEY_PATH=/root/.ssh/processing-to-storage
      - SSH_PRIVATE_KEY_PASSPHRASE=
      - ENV=development
      - LOGFIRE_TOKEN=${LOGFIRE_TOKEN}
      # Service role key for accessing auth.users (user email lookup)
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY:-}
      # Linear integration for processing failure notifications
      - LINEAR_ENABLED=${LINEAR_ENABLED:-false}
      - LINEAR_API_KEY=${LINEAR_API_KEY:-}

      # NVIDIA GPU configuration
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    # command: python -m debugpy --listen 0.0.0.0:5678 -c "print('Call the Processor Debugger individually.')"
    command: tail -f /dev/null
    deploy:
      resources:
        limits:
          cpus: '12'
          memory: '64G'
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    runtime: nvidia

  api-test:
    build:
      context: .
      dockerfile: api/Dockerfile
    healthcheck:
      test: curl --fail http://127.0.0.1:8017/ || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 1m30s
      start_interval: 1s
    ports:
      - '8017:8017'
      - '5679:5679'
    volumes:
      - ./data:/data:rw
      - ./api:/app/api # dev only, no rebuild needed
      - ./shared:/app/shared # dev only, no rebuild needed
      - ./assets:/app/assets
    environment:
      - PYTHONPATH=/app
      - UVICORN_HOST=0.0.0.0
      - UVICORN_PORT=8017
      - PYTEST_ADDOPTS=--color=yes
      - SUPABASE_URL=http://host.docker.internal:54321
      - SUPABASE_KEY=${SUPABASE_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY:-}
      - BASE_DIR=/data
      - ENV=development
      - LOGFIRE_TOKEN=${LOGFIRE_TOKEN}
      # Daily summary: PostHog integration
      - POSTHOG_API_KEY=${POSTHOG_API_KEY:-}
      - POSTHOG_PROJECT_ID=${POSTHOG_PROJECT_ID:-}
      - POSTHOG_HOST=${POSTHOG_HOST:-https://eu.posthog.com}
      # Daily summary: Zulip integration
      - ZULIP_EMAIL=${ZULIP_EMAIL:-}
      - ZULIP_API_KEY=${ZULIP_API_KEY:-}
      - ZULIP_SITE=${ZULIP_SITE:-}
      - ZULIP_STREAM=${ZULIP_STREAM:-project_deadtree.earth}
      - ZULIP_TOPIC=${ZULIP_TOPIC:-Daily Summary}
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    # command: python -m debugpy --listen 0.0.0.0:5679 run.py server --reload=True
    command: python api/src/run.py server --reload=True

  nginx:
    build:
      context: ./nginx
      dockerfile: test-conf/Dockerfile
    healthcheck:
      test: ['CMD', 'service', 'nginx', 'status']
      interval: 15s
      timeout: 1s
      retries: 5
      start_period: 2s
    ports:
      - 8080:80
      - 2222:22
    volumes:
      - ./data:/data/:rw
      # Mount your Ed25519 public key for authorized_keys
      # - ~/.ssh/processing-to-storage.pub:/root/.ssh/authorized_keys:ro
      - ~/.ssh/processing-to-storage.pub:/tmp/ssh-keys/processing-to-storage.pub:ro
      - ./nginx/test-conf:/etc/nginx/conf.d/:ro


  

networks:
  default:
    name: deadwood_network

# volumes:
  # nginx_ssh:  # This can be removed if not used by other services
