services:
  processor-test:
    build:
      context: .
      dockerfile: processor/Dockerfile
    # healthcheck:
    #   test: curl --fail http://127.0.0.1:5678/ || exit 1
    #   interval: 15s
    #   timeout: 1s
    #   retries: 5
    #   start_period: 2s
    ports:
      - '5678:5678'
    volumes:
      - ./data:/data # need it for testing (pulling and pushing files to storage server)
      - ${SSH_PRIVATE_KEY_PATH}:/app/ssh_key
      - ./processor:/app/processor
      - ./shared:/app/shared
      - ./assets:/app/assets
    environment:
      - PYTHONPATH=/app
      - PYTEST_ADDOPTS=--color=yes
      - STORAGE_SERVER_IP=nginx
      - STORAGE_SERVER_USERNAME=root
      - STORAGE_SERVER_DATA_PATH=/data
      - PROCESSOR_USERNAME=processor@deadtrees.earth
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - BASE_DIR=/data
      - PROCESSOR_PASSWORD=${PROCESSOR_PASSWORD}
      - SSH_PRIVATE_KEY_PATH=/app/ssh_key
      - SSH_PRIVATE_KEY_PASSPHRASE=${SSH_PRIVATE_KEY_PASSPHRASE}
      - DEV_MODE=true
      - LOGFIRE_TOKEN=${LOGFIRE_TOKEN}
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    # command: python -m debugpy --listen 0.0.0.0:5678 -c "print('Call the Processor Debugger individually.')"
    command: tail -f /dev/null

  api-test:
    build:
      context: .
      dockerfile: api/Dockerfile
    healthcheck:
      test: curl --fail http://127.0.0.1:8017/ || exit 1
      interval: 15s
      timeout: 1s
      retries: 5
      start_period: 2s
    ports:
      - '8017:8017'
      - '5679:5679'
    volumes:
      - ./data:/data:rw
      - ./api:/app/api # dev only, no rebuild needed
      - ./shared:/app/shared # dev only, no rebuild needed
      - ./assets:/app/assets
    environment:
      - PYTHONPATH=/app
      - UVICORN_HOST=0.0.0.0
      - UVICORN_PORT=8017
      - PYTEST_ADDOPTS=--color=yes
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - BASE_DIR=/data
      - DEV_MODE=true
      - LOGFIRE_TOKEN=${LOGFIRE_TOKEN}
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    # command: python -m debugpy --listen 0.0.0.0:5679 run.py server --reload=True
    command: python run.py server --reload=True

  nginx:
    image: nginx
    ports:
      - 8080:80
      - '2222:22'
    links:
      - api-test
    depends_on:
      api-test:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'service', 'nginx', 'status']
      interval: 15s
      timeout: 2s
      retries: 5
      start_period: 3s
    volumes:
      - ./nginx/conf:/etc/nginx/conf.d/:ro
      - ./data:/data/
      - ${SSH_PRIVATE_KEY_PATH}.pub:/root/.ssh/authorized_keys:rw
    command: >
      sh -c "apt-get update &&
             apt-get install -y openssh-server &&
             mkdir -p /run/sshd &&
             mkdir -p /root/.ssh &&
             chmod 700 /root/.ssh &&
             chmod 600 /root/.ssh/authorized_keys &&
             /usr/sbin/sshd &&
             nginx -g 'daemon off;'"

  tests:
    build:
      context: .
      dockerfile: tests/Dockerfile
    links:
      - nginx
      - api-test
    depends_on:
      nginx:
        condition: service_healthy
    environment:
      COG_URL: http://nginx:80/cogs/v1
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    volumes:
      - ./assets:/app/assets/:ro
      - ./tests:/app/tests # dev only, no rebuild needed
    # command: pytest -s test_performance.py
    # command: tail -f /dev/null # Keeps container running indefinitely

networks:
  default:
    name: deadwood_network
