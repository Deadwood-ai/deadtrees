services:
  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    restart: unless-stopped
    ports:
      - 127.0.0.1:40831:40831
      # - 2222:22  # Expose SSH port
    volumes:
      - /data:/data
      - ./assets/gadm/gadm_410.gpkg:/gadm_data/gadm_410.gpkg
      - ~/.ssh/authorized_keys:/home/dendro/.ssh/authorized_keys:ro
    
    healthcheck:
      test: curl --fail http://127.0.0.1:40831/ || exit 1
      interval: 1m
      timeout: 10s
      retries: 5
      start_period: 1m30s
      start_interval: 1s

    environment:
      BASE_DIR: /data
      PYTHONPATH: /app
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_KEY: ${SUPABASE_KEY}
      DEV_MODE: false
      GADM_DATA_PATH: /gadm_data/gadm_410.gpkg
      UVICORN_ROOT_PATH: /api/v1
      UVICORN_PORT: 40831
      UVICORN_HOST: 0.0.0.0
      LOGFIRE_TOKEN: ${LOGFIRE_TOKEN}
      # Reference export configuration
      REFERENCE_EXPORT_UUID: ${REFERENCE_EXPORT_UUID}
      NGINX_COG_URL: ${NGINX_COG_URL}
      DEADTREES_USER: ${DEADTREES_USER}
      DEADTREES_PASSWORD: ${DEADTREES_PASSWORD}
      # Service role key for accessing auth.users (user email lookup)
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:-}
      # Daily summary: PostHog integration
      POSTHOG_API_KEY: ${POSTHOG_API_KEY:-}
      POSTHOG_PROJECT_ID: ${POSTHOG_PROJECT_ID:-}
      POSTHOG_HOST: ${POSTHOG_HOST:-https://eu.posthog.com}
      # Daily summary: Zulip integration
      ZULIP_EMAIL: ${ZULIP_EMAIL:-}
      ZULIP_API_KEY: ${ZULIP_API_KEY:-}
      ZULIP_SITE: ${ZULIP_SITE:-}
      ZULIP_STREAM: ${ZULIP_STREAM:-project_deadtree.earth}
      ZULIP_TOPIC: ${ZULIP_TOPIC:-Daily Summary}
      # Daily summary: Linear integration
      LINEAR_ENABLED: ${LINEAR_ENABLED:-true}
      LINEAR_API_KEY: ${LINEAR_API_KEY:-}
      LINEAR_TEAM_ID: ${LINEAR_TEAM_ID:-ba4011bf-0b5c-4631-9f88-1034ab4ef541}

    # command: python run.py server --reload=False

  # NOTE:
  # NGINX runs on the host (systemd) on the production storage server.
  # This compose file only manages the API container to avoid port conflicts on 80/443.