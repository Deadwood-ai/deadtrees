---
description: Core project rules - security, architecture, and essential gotchas
alwaysApply: true
---
# DeadTrees Agent Rules

## Security Constraints (NEVER Violate)

- **NEVER SSH to remote machines without explicit user consent** - Always ask first
- **NEVER commit or push without user approval** - Always ask before git operations
- **NEVER bypass MCP for database access** - Use `user-deadtrees-prod` or `user-deadtrees-local`

---

## Architecture (Critical Knowledge)

### Production: Two Separate Physical Machines

| Machine | Services | Has /data? |
|---------|----------|------------|
| **API Server** | NGINX (host), FastAPI (Docker), file storage | YES |
| **Processor Server** | Processor, ODM containers, TCD containers | NO |

**Key insight:** No shared filesystem. Data transfer via SSH pull/push.

### API Server Deployment (data.deadtrees.earth)

- **API:** Runs in Docker via `docker compose -f docker-compose.api.yaml up -d api`
- **nginx:** Runs on HOST (systemd), NOT Docker - config at `nginx/conf/storage-server.conf`
- **Auto-deploy:** `auto_deploy_api.sh` (local only) pulls and redeploys API on new commits
- **Port conflict:** NEVER run `docker compose -f docker-compose.api.yaml up -d` without specifying `api` - Docker nginx will conflict with host nginx on port 80

See `docs/ops/api-server-deployment.md` for full details.

### Test Environment
- Processor container has **NO /data mount** (simulates production separation)
- Uses SSH to nginx container (port 2222)

### Why Named Volumes
- No shared filesystem between machines
- Avoids permission issues (ODM UID 999 ≠ processor UID)

### Critical: Standardized File Flow
- Original ortho: `/data/archive/XXXX_ortho.tif` (preserved, may be untiled)
- Standardized ortho: **LOCAL in processor only** (tiled, NOT pushed back to storage)
- `ssh.py` skip-if-exists reuses local tiled file for all downstream tasks
- This prevents "Chunk and warp failed" errors in treecover

---

## Known Bugs & Gotchas

### Active Bug: Tar Streaming Memory Exhaustion
- **Location:** `processor/src/utils/shared_volume.py:189`, `predict_treecover.py:354`
- **Problem:** `io.BytesIO(b''.join(archive_stream))` loads entire archive into RAM
- **Fix:** Stream directly: `tarfile.open(mode='r|*', fileobj=archive_stream)`

### Data Gotchas

| Issue | Reality |
|-------|---------|
| File sizes in DB | **MB not bytes** (7366 = 7.2 GB) |
| Phenology path | Has `_filled` suffix: `modispheno_aggregated_normalized_filled.zarr` |
| User privileges table | `privileged_users` not `v2_users` |
| Legacy tables | `v1_label_objects` dropped, `v2_queue_positions` doesn't exist |

### Operational: Re-queuing Failed Datasets (Prod)
- **Prod DB writes:** `user-deadtrees-prod` MCP is read-only. Use the API endpoint (preferred) or Supabase Studio for manual SQL.
- **API re-queue:** `PUT https://data2.deadtrees.earth/api/v1/datasets/<ID>/process` with a processor Bearer token.
- **OOM/exit 137:** These are the best candidates to rerun after ODM memory/concurrency fixes (search `v2_statuses.error_message` / `v2_logs.message` for `exit code 137`).
- **Critical:** when re-running any downstream stage, always include `geotiff` (standardized ortho is ephemeral).
- Full workflow + snippets live in `.cursor/rules/data-debugging.mdc` (search: “Alternative: API Endpoint”).

---

## Conventions (Non-Standard)

### Python
- **Tabs, not spaces**
- Prefer functions over classes for business logic

### Testing
- **Sync tests only** - no `async def`, no `@pytest.mark.asyncio`
- Use `deadtrees` CLI, never `pytest` directly in containers
- Use real data and fixtures, avoid mocking

### CLI
```bash
deadtrees dev start/stop        # Manage test stack
deadtrees dev test api/processor
deadtrees dev debug api --test-path=...
```

---

## External Services

| Server | Purpose |
|--------|---------|
| `user-deadtrees-prod` | Production database (read-only) |
| `user-deadtrees-local` | Local database |
| `user-Linear` | Issue tracking |
| `user-zulip` | Team communication |

**GitHub:** `Deadwood-ai/deadtrees`
**Zulip:** `project_deadtree.earth` channel
