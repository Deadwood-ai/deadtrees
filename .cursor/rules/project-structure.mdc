---
alwaysApply: true
---
# Project Structure & Organization

## ğŸ“‹ **WHEN TO USE THIS RULE**
**Agent should request this rule when:**
- Creating new modules, utilities, or services
- Deciding where to place functions or classes
- Organizing tests or implementing new features
- Refactoring existing code for better structure

## ğŸ—ï¸ **MODULE ORGANIZATION PRINCIPLES**

### **Separation of Concerns**
```python
# âœ… GOOD: Each module has a single responsibility
api/src/utils/file_utils.py    # File type detection, validation
api/src/utils/exif_utils.py    # EXIF extraction logic  
api/src/utils/rtk_utils.py     # RTK file processing
api/src/upload/upload.py       # Dataset creation only
api/src/routers/upload.py      # HTTP endpoint logic only

# âŒ BAD: Mixed responsibilities
api/src/upload/upload.py       # Dataset creation + file detection + EXIF + RTK
```

### **Import Hierarchy**
```python
# âœ… GOOD: Clear dependency flow
routers/ â†’ utils/     # Routers use utilities
routers/ â†’ upload/    # Routers use business logic  
upload/  â†’ utils/     # Business logic uses utilities

# âŒ BAD: Circular dependencies
utils/ â†’ routers/     # Utils should not depend on routers
upload/ â†’ routers/    # Business logic should not depend on HTTP layer
```

### **Reusability Guidelines**
```python
# âœ… Place in utils/ if:
- Function is stateless
- Used by multiple modules  
- General-purpose utility
- No domain-specific business logic

# âœ… Place in service modules if:
- Contains business logic
- Manages state or resources
- Domain-specific operations
- Database interactions

# âœ… Place in routers/ if:
- HTTP-specific logic
- Request/response handling
- Authentication/authorization
- API endpoint definitions
```

## ğŸ§ª **TEST ORGANIZATION PATTERNS**

### **Co-located Testing (Preferred)**
```
shared/
â”œâ”€â”€ models.py
â””â”€â”€ tests/
    â”œâ”€â”€ test_models.py          # Tests shared/models.py
    â””â”€â”€ test_odm_models.py      # Tests ODM-specific models

api/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ utils/file_utils.py
â”‚   â”œâ”€â”€ upload/upload.py  
â”‚   â””â”€â”€ routers/upload.py
â””â”€â”€ tests/
    â”œâ”€â”€ utils/
    â”‚   â””â”€â”€ test_file_utils.py  # Tests api/src/utils/file_utils.py
    â”œâ”€â”€ upload/
    â”‚   â””â”€â”€ test_upload.py      # Tests api/src/upload/upload.py
    â””â”€â”€ routers/
        â””â”€â”€ test_upload.py      # Tests api/src/routers/upload.py
```

### **Test Categories**
```python
# Unit tests: Test individual functions/classes
api/tests/utils/test_file_utils.py
processor/tests/test_process_odm.py

# Integration tests: Test module interactions  
api/tests/test_upload_integration.py
processor/tests/test_odm_pipeline.py

# End-to-end tests: Test complete workflows
integration/tests/test_complete_workflow.py
```

### **Test Naming Conventions**
```python
# âœ… GOOD: Clear, descriptive names
test_detect_upload_type_with_geotiff_file()
test_detect_upload_type_with_zip_file()
test_detect_upload_type_raises_error_for_unsupported_type()

# âŒ BAD: Vague or unclear names  
test_upload_type()
test_detection()
test_error()
```

## ğŸ“ **RECOMMENDED FILE STRUCTURE**

### **API Service Structure**
```
api/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ utils/                 # ğŸ”§ Reusable utilities
â”‚   â”‚   â”œâ”€â”€ file_utils.py      # File type detection, validation
â”‚   â”‚   â”œâ”€â”€ exif_utils.py      # EXIF data extraction
â”‚   â”‚   â”œâ”€â”€ rtk_utils.py       # RTK file processing
â”‚   â”‚   â””â”€â”€ validation.py      # Common validation functions
â”‚   â”œâ”€â”€ upload/                # ğŸ“¤ Upload business logic
â”‚   â”‚   â”œâ”€â”€ upload.py          # Dataset creation
â”‚   â”‚   â””â”€â”€ raw_images_processor.py  # ZIP processing logic
â”‚   â”œâ”€â”€ routers/               # ğŸŒ HTTP endpoints
â”‚   â”‚   â”œâ”€â”€ upload.py          # Upload endpoints
â”‚   â”‚   â”œâ”€â”€ datasets.py        # Dataset management
â”‚   â”‚   â””â”€â”€ processing.py      # Processing control
â”‚   â””â”€â”€ services/              # ğŸ¢ Domain services (if needed)
â””â”€â”€ tests/                     # ğŸ§ª Mirror src/ structure
    â”œâ”€â”€ utils/
    â”œâ”€â”€ upload/
    â””â”€â”€ routers/
```

### **Processor Service Structure**  
```
processor/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ utils/                 # ğŸ”§ Processing utilities
â”‚   â”‚   â”œâ”€â”€ docker_utils.py    # Docker container management
â”‚   â”‚   â”œâ”€â”€ file_transfer.py   # SSH/file operations
â”‚   â”‚   â””â”€â”€ path_utils.py      # Path management
â”‚   â”œâ”€â”€ processors/            # âš™ï¸ Individual processors
â”‚   â”‚   â”œâ”€â”€ process_odm.py     # ODM processing
â”‚   â”‚   â”œâ”€â”€ process_cog.py     # COG generation
â”‚   â”‚   â””â”€â”€ process_metadata.py # Metadata extraction
â”‚   â””â”€â”€ processor.py           # ğŸ¯ Main orchestrator
â””â”€â”€ tests/                     # ğŸ§ª Mirror src/ structure
    â”œâ”€â”€ utils/
    â””â”€â”€ processors/
```

## ğŸ¯ **NAMING CONVENTIONS**

### **Module Names**
```python
# âœ… GOOD: Clear, descriptive module names
file_utils.py       # File-related utilities
exif_utils.py       # EXIF extraction utilities  
rtk_utils.py        # RTK processing utilities
raw_images_processor.py  # Raw images processing

# âŒ BAD: Vague or generic names
utils.py           # Too generic
helper.py          # Too vague
common.py          # Unclear purpose
```

### **Function Names** 
```python
# âœ… GOOD: Verb-noun pattern, clear intent
detect_upload_type()
extract_exif_data()
process_raw_images_upload()
validate_zip_structure()

# âŒ BAD: Unclear or overly generic
get_type()
do_upload()
handle_file()
process()
```

### **Class Names**
```python
# âœ… GOOD: Noun phrases, clear purpose
class UploadType(Enum):
class ProcessingRequest(BaseModel):
class ODMProcessor:

# âŒ BAD: Vague or abbreviated
class Type:
class Request:
class Processor:
```

## ğŸš¨ **ANTI-PATTERNS TO AVOID**

### **âŒ God Modules**
```python
# BAD: One module doing everything
upload.py  # 2000+ lines handling upload, processing, validation, etc.

# GOOD: Split by responsibility  
upload/upload.py         # Dataset creation (200 lines)
utils/file_utils.py      # File utilities (100 lines)
utils/exif_utils.py      # EXIF extraction (150 lines)
```

### **âŒ Circular Dependencies**
```python
# BAD: Modules depending on each other
upload.py â†’ router.py â†’ upload.py

# GOOD: Unidirectional dependency flow
router.py â†’ upload.py â†’ utils.py
```

### **âŒ Deep Import Paths**
```python
# BAD: Too many nested levels
from api.src.upload.processors.image.exif.extraction import extract_exif

# GOOD: Flatter structure with clear modules
from api.src.utils.exif_utils import extract_exif
```

### **âŒ Generic Naming**
```python
# BAD: Generic, unclear names
utils.py, helper.py, common.py, manager.py

# GOOD: Specific, descriptive names  
file_utils.py, exif_utils.py, rtk_utils.py, odm_processor.py
```

## ğŸ“š **BEST PRACTICES SUMMARY**

### **Code Organization**
1. **One responsibility per module** - clear, focused purpose
2. **Co-locate related functionality** - keep related code together
3. **Minimize dependencies** - reduce coupling between modules
4. **Use descriptive names** - make intent clear from naming
5. **Follow import hierarchy** - utils â† business logic â† routers

### **Test Organization**  
1. **Mirror source structure** - tests in same relative locations
2. **Test one thing per test** - focused, specific test cases
3. **Use descriptive test names** - make test purpose clear
4. **Group related tests** - use test classes for organization
5. **Real data over mocking** - use actual data when possible

### **Test Fixtures Location** âš ï¸
- **NEVER** place test fixtures in `assets/test_data/` or `test_data/`
- **ALWAYS** place test fixtures in `{service}/tests/fixtures/`
- Examples:
  - âœ… `processor/tests/fixtures/sample_geotiff.tif`
  - âœ… `api/tests/fixtures/sample_upload.zip`
  - âŒ `assets/test_data/sample_geotiff.tif`
  - âŒ `test_data/debugging/sample.tif`
- Rationale: Keep test data co-located with tests, mounted in test containers

### **File Structure**
1. **Flatten when possible** - avoid deep nesting
2. **Group by feature** - related functionality together
3. **Separate concerns** - utils/business logic/HTTP layers
4. **Consistent naming** - follow established patterns
5. **Document structure** - README files for complex modules

---

**Remember**: Good structure makes code easier to understand, test, and maintain. When in doubt, prefer clarity and simplicity over clever organization.
description: